name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: |
          shellcheck bootstrap.sh
          shellcheck home/dot_zshrc
          shellcheck home/dot_zprofile
          shellcheck home/dot_zaliases

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        chezmoi: [pre-installed, not-installed]

    steps:
      - uses: actions/checkout@v4

      - name: Install chezmoi
        if: matrix.chezmoi == 'pre-installed'
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Create chezmoi config
        run: |
          mkdir -p "$HOME/.config/chezmoi"
          printf '[data]\n  name = "Test User"\n  email = "test@example.com"\n  signingkey = ""\n' > "$HOME/.config/chezmoi/chezmoi.toml"

      - name: Run bootstrap.sh
        run: bash bootstrap.sh --yes

      - name: Debug - list home directory
        run: |
          echo "HOME: $HOME"
          find "$HOME" -maxdepth 1 -name '.*' | sort || true
          ls -la "$HOME/.config/" 2>/dev/null || echo ".config not found"

      - name: Verify files exist
        run: |
          test -f "$HOME/.zshrc"
          test -f "$HOME/.zshenv"
          test -f "$HOME/.gitconfig"
          test -f "$HOME/.zaliases"
          test -f "$HOME/.zprofile"
          test -f "$HOME/.config/sheldon/plugins.toml"

      - name: Verify gitconfig content
        run: |
          grep -q "Test User" "$HOME/.gitconfig"
          grep -q "test@example.com" "$HOME/.gitconfig"

      - name: Install shellcheck
        if: runner.os == 'Linux'
        run: sudo apt-get install -y shellcheck

      - name: Shellcheck rendered files
        if: runner.os == 'Linux'
        run: |
          shellcheck "$HOME/.zshrc"
          shellcheck "$HOME/.zshenv"
          shellcheck "$HOME/.zprofile"
          shellcheck "$HOME/.zaliases"

      - name: Verify signing config is absent when signingkey is empty
        run: |
          ! grep -q "\[gpg\]" "$HOME/.gitconfig"

  test-chezmoi-init:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Install chezmoi
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Create chezmoi config
        run: |
          mkdir -p "$HOME/.config/chezmoi"
          printf '[data]\n  name = "Test User"\n  email = "test@example.com"\n  signingkey = ""\n' > "$HOME/.config/chezmoi/chezmoi.toml"

      - name: Run chezmoi init --apply
        run: chezmoi init --apply github.com/tafuru/dotfiles

      - name: Verify files exist
        run: |
          test -f "$HOME/.zshrc"
          test -f "$HOME/.zshenv"
          test -f "$HOME/.gitconfig"
          test -f "$HOME/.zaliases"
          test -f "$HOME/.zprofile"
          test -f "$HOME/.config/sheldon/plugins.toml"

      - name: Verify gitconfig content
        run: |
          grep -q "Test User" "$HOME/.gitconfig"
          grep -q "test@example.com" "$HOME/.gitconfig"

      - name: Verify signing config is absent when signingkey is empty
        run: |
          ! grep -q "\[gpg\]" "$HOME/.gitconfig"
