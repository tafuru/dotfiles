name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run shellcheck
        run: |
          shellcheck bootstrap.sh
          shellcheck home/dot_zshrc
          shellcheck home/dot_zprofile
          shellcheck home/dot_zaliases

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm, macos-latest]
        install-method: [bootstrap-pre, bootstrap-none, chezmoi-init]

    steps:
      - uses: actions/checkout@v4
        if: startsWith(matrix.install-method, 'bootstrap')

      - name: Install chezmoi
        if: matrix.install-method != 'bootstrap-none'
        run: |
          sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Run bootstrap.sh
        if: startsWith(matrix.install-method, 'bootstrap')
        env:
          CHEZMOI_GIT_NAME: "Test User"
          CHEZMOI_GIT_EMAIL: "test@example.com"
        run: bash bootstrap.sh --yes

      - name: Run chezmoi init --apply
        if: matrix.install-method == 'chezmoi-init'
        env:
          CHEZMOI_GIT_NAME: "Test User"
          CHEZMOI_GIT_EMAIL: "test@example.com"
        run: chezmoi init --apply github.com/tafuru/dotfiles

      - name: Verify files exist
        run: |
          test -f "$HOME/.zshrc"
          test -f "$HOME/.zshenv"
          test -f "$HOME/.gitconfig"
          test -f "$HOME/.zaliases"
          test -f "$HOME/.zprofile"
          test -f "$HOME/.config/sheldon/plugins.toml"
          test -f "$HOME/.config/mise/config.toml"
          test -f "$HOME/.config/starship.toml"
          test -f "$HOME/.config/ghostty/config"
          test -f "$HOME/.config/zellij/config.kdl"

      - name: Verify mise config content
        run: grep -q "rust" "$HOME/.config/mise/config.toml"

      - name: Verify gitconfig content
        run: |
          grep -q "Test User" "$HOME/.gitconfig"
          grep -q "test@example.com" "$HOME/.gitconfig"

      - name: Install shellcheck
        if: runner.os == 'Linux'
        run: sudo apt-get install -y shellcheck

      - name: Shellcheck rendered files
        if: runner.os == 'Linux'
        run: |
          shellcheck "$HOME/.zshrc"
          shellcheck "$HOME/.zshenv"
          shellcheck "$HOME/.zprofile"
          shellcheck "$HOME/.zaliases"

      - name: Verify signing config is absent when signingkey is empty
        run: |
          ! grep -q "\[gpg\]" "$HOME/.gitconfig"

  notify-dev-setup:
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger dev-setup CI
        run: |
          curl -fsSL -X POST \
            -H "Authorization: token ${{ secrets.DEV_SETUP_DISPATCH_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/tafuru/dev-setup/dispatches \
            -d '{"event_type":"upstream-changed","client_payload":{"source":"dotfiles"}}'

